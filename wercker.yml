box:
    id: $DOCKER_USERNAME/miksu
    tag: latest
    registry: https://registry.hub.docker.com

build:
  steps:
    - npm-install
deploy:
  steps:
    #- add-to-known_hosts:
    #    hostname: $HOST
      - mktemp:
        envvar: PRIVATEKEY_PATH
      - create-file:
        name: write key
        filename: $PRIVATEKEY_PATH
        content: $FOO_PRIVATE
        overwrite: true
    - script:
      name: ssh-ls
      code: ssh -i $PRIVATEKEY_PATH -l opc -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $HOST
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        tag: latest
        repository: $DOCKER_USERNAME/miksu
        ports: "3000"
        cmd: npm start
        registry: https://registry.hub.docker.com
    - script: 
        name: redeploy-OCCS
        code: |
              #curl -k -H "Content-Type: application/json" -X POST $OCCS_WEBHOOK // OCCS WEBHOOK
              curl -v -X POST -F token=$OCCS_TOKEN -F host=$OCCS_HOST -F deployment=$OCCS_DEPLOYMENT -F filter=$OCCS_FILTER $OCCS_ROLLING_UPDATE_HOST
